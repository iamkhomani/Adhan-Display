<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BEKQEF4RR5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BEKQEF4RR5');
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
      if (!localStorage.getItem('adhan_theme')) {
          localStorage.setItem('adhan_theme', 'light');
      }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Adhan Display">
    
    <link rel="apple-touch-icon" href="images/adhan%20display%20muslim%20prayer%20times%20dashboard%20logo.png">
    <link rel="icon" type="image/png" href="images/adhan%20display%20muslim%20prayer%20times%20dashboard%20logo.png">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&display=swap" rel="stylesheet">

    <title>Adhan Display: Live Prayer Times & Prayer Tracker</title>
    <meta name="description" content="Turn any screen into a beautiful Adhan Display. Features live Muslim prayer times, Qibla finder, daily Tasbih, and a personal prayer tracker for your home or mosque.">
    <meta name="keywords" content="Adhan Display, Prayer Times, Prayer Tracker, Qibla Finder, Muslim Dashboard, Islamic Clock">

    <meta property="og:title" content="Adhan Display: Live Prayer Times & Prayer Tracker">
    <meta property="og:description" content="Turn any screen into a beautiful Adhan display. Live prayer times, Qibla finder, and prayer tracker.">
    <meta property="og:image" content="https://adhandisplay.com/images/adhan%20display%20muslim%20prayer%20times%20dashboard%20logo.png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Adhan Display",
      "url": "https://adhandisplay.com/",
      "description": "A live prayer times dashboard, Qibla finder, and prayer tracker for your home display.",
      "applicationCategory": "LifestyleApplication",
      "image": "https://adhandisplay.com/images/adhan%20display%20muslim%20prayer%20times%20dashboard%20logo.png"
    }
    </script>
    
    <style>
        /* === THEME VARIABLES === */
        :root {
            --bg-image: url('images/adhan display muslim prayer times dashboard background.jpg');
            --gold: #D4AF37; --gold-dim: #997d26;
            --glass-bg: rgba(20, 20, 20, 0.85);
            --glass-header: rgba(0, 0, 0, 0.65);
            --text-main: #f0f0f0; --text-muted: #aaaaaa;
            --border-color: #333333; --progress-bg: #222222;
            --shadow-color: rgba(0,0,0,0.5);
            --danger: #ff4444; --success: #2ecc71;
        }

        [data-theme="light"] {
            --bg-image: url('images/background-white.jpg');
            --gold: #b8972e; --gold-dim: #8a7122;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-header: rgba(240, 240, 240, 0.85);
            --text-main: #1a1a1a; --text-muted: #555555;
            --border-color: #dddddd; --progress-bg: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
        }

        [data-theme="green"] {
            --bg-image: url('images/background-green.png');
            --gold: #D4AF37; --gold-dim: #997d26;
            --glass-bg: rgba(10, 35, 20, 0.85);
            --glass-header: rgba(5, 20, 10, 0.8);
            --text-main: #f0f0f0; --text-muted: #cccccc;
            --border-color: #1a4d2e; --progress-bg: #0a1f12;
            --shadow-color: rgba(0,0,0,0.6);
        }

        /* Dynamic Theme Styling */
        [data-theme="dynamic"] {
            --glass-bg: rgba(15, 15, 20, 0.85); 
            --glass-header: rgba(10, 10, 15, 0.75);
            --border-color: rgba(212, 175, 55, 0.3);
            --shadow-color: rgba(0,0,0,0.7);
        }
        [data-theme="dynamic"][data-time-of-day="fajr"] {
            --bg-image: linear-gradient(135deg, #0d0a1a 0%, #2b183d 50%, #5e2843 100%);
            --text-main: #ffe6e6;
        }
        [data-theme="dynamic"][data-time-of-day="day"] {
            --bg-image: linear-gradient(135deg, #1a2a6c 0%, #11998e 50%, #2b3a4a 100%);
            --text-main: #f0f8ff;
        }
        [data-theme="dynamic"][data-time-of-day="night"] {
            --bg-image: linear-gradient(135deg, #050505 0%, #0a0a1a 50%, #1a1a2e 100%);
            --text-main: #e0e0e0;
        }

        html { font-size: 16px; transition: font-size 0.3s ease; }

        body {
            background-image: var(--bg-image); background-size: cover;
            background-position: center; background-attachment: fixed;
            background-color: #050505; color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; min-height: 100vh; padding-bottom: 80px;
            display: flex; flex-direction: column; overflow-x: hidden;
            transition: background-image 1s ease, color 0.5s ease;
        }

        /* RTL (Arabic) Support */
        html[dir="rtl"] body { font-family: 'Tajawal', 'Segoe UI', sans-serif; }
        html[dir="rtl"] .top-left-logo { left: auto; right: 20px; }
        html[dir="rtl"] .settings-toggle { right: auto; left: 20px; }
        html[dir="rtl"] .focus-toggle { right: auto; left: 75px; }

        .dashboard-container {
            max-width: 1400px; margin: 0 auto; padding: 20px;
            display: grid; grid-template-columns: repeat(12, 1fr);
            gap: 20px; flex: 1; position: relative; width: 100%; box-sizing: border-box;
            transition: all 0.5s ease;
        }

        /* Top Bar Controls */
        .top-left-logo { position: absolute; top: 20px; left: 20px; width: clamp(50px, 8vw, 70px); height: auto; z-index: 10; }

        .settings-toggle {
            position: absolute; top: 20px; right: 20px; background: var(--glass-bg);
            border: 1px solid var(--gold); color: var(--text-main); font-size: 1.5rem;
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px var(--shadow-color); transition: transform 0.3s, border-color 0.3s, background 0.3s;
        }
        
        .focus-toggle {
            position: absolute; top: 20px; right: 75px; background: var(--glass-bg);
            border: 1px solid var(--gold); color: var(--text-main); font-size: 0.95rem; font-weight: bold;
            height: 45px; padding: 0 15px; border-radius: 25px; cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            box-shadow: 0 4px 10px var(--shadow-color); transition: transform 0.3s, border-color 0.3s, background 0.3s;
        }

        .settings-toggle:hover, .focus-toggle:hover { transform: scale(1.05); background: var(--gold); color: #050505; }

        /* Focus Mode Styles */
        body.focus-mode .dashboard-container > *:not(.prayer-hero) { display: none !important; }
        body.focus-mode header, body.focus-mode footer, body.focus-mode .top-left-logo { display: none !important; }
        body.focus-mode .dashboard-container { display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; height: 100vh !important; padding: 0 20px !important; margin: 0 !important; }
        
        body.focus-mode .prayer-hero { 
            width: 100% !important; max-width: 1000px !important; 
            background: var(--glass-bg) !important; border: 2px solid var(--gold) !important; 
            box-shadow: 0 20px 50px var(--shadow-color) !important; backdrop-filter: blur(15px) !important; 
            padding: 50px 30px !important; min-height: auto !important; border-radius: 20px !important; 
        }
        
        body.focus-mode .prayer-name-display { font-size: clamp(4rem, 15vw, 7rem) !important; margin: 20px 0 !important; }
        body.focus-mode .countdown-display { font-size: clamp(3rem, 12vw, 6rem) !important; margin-bottom: 30px !important; }
        body.focus-mode .progress-container { height: 18px !important; margin-top: 30px !important; border-radius: 10px !important; }
        body.focus-mode #status-label, body.focus-mode #next-label { font-size: clamp(1.2rem, 4vw, 2rem) !important; letter-spacing: 2px !important; }
        body.focus-mode #curr-time { font-size: clamp(2rem, 6vw, 3rem) !important; margin-bottom: 20px !important; }
        body.focus-mode .focus-toggle { border-color: var(--gold) !important; background: var(--gold) !important; color: #050505 !important; z-index: 1000 !important; }

        /* Modal / Settings */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .settings-panel { background: var(--glass-bg); border: 1px solid var(--gold); padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; position: relative; color: var(--text-main); box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto; overflow-x: hidden; }
        
        /* Fixed visible Close Button */
        .close-btn { 
            position: absolute; top: 15px; right: 15px; 
            background: var(--danger); border: 2px solid #fff; 
            font-size: 1.5rem; color: #fff; cursor: pointer; 
            width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.2s;
            z-index: 10000;
        }
        .close-btn:hover { transform: scale(1.1); background: #cc0000; }
        html[dir="rtl"] .close-btn { right: auto; left: 15px; }

        .setting-group { margin-bottom: 25px; }
        .setting-group label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--gold); text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; }
        .flex-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .opt-btn { flex: 1; min-width: 40px; padding: 10px; background: transparent; border: 1px solid var(--border-color); color: var(--text-main); border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; text-align: center; }
        .opt-btn:hover { border-color: var(--gold); }
        .opt-btn.active { background: var(--gold); color: #050505; border-color: var(--gold); }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; }
        .preview-btn { background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--gold); border-radius: 6px; padding: 0 15px; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .preview-btn:hover { border-color: var(--gold); background: var(--gold); color: #050505; }

        /* Unified Gold Borders for Cards */
        .card { background: var(--glass-bg); border: 1px solid var(--gold); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px); box-shadow: 0 4px 20px var(--shadow-color); transition: all 0.3s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; grid-column: span 12; box-sizing: border-box; width: 100%; }
        .card:hover { box-shadow: 0 4px 25px rgba(212, 175, 55, 0.2); transform: translateY(-2px); }
        .widget-title { color: var(--gold-dim); text-transform: uppercase; font-size: 0.8rem; border-bottom: 1px solid var(--gold); width: 100%; text-align: center; padding-bottom: 5px; margin-bottom: 15px; letter-spacing: 1px; }
        
        .header-section { grid-column: span 12; text-align: center; margin-bottom: 20px; display: flex; justify-content: center; margin-top: 70px; width: 100%; }
        .title-wrapper { background: var(--glass-header); backdrop-filter: blur(8px); padding: clamp(15px, 4vw, 20px) clamp(20px, 5vw, 40px); border-radius: 20px; border: 1px solid var(--gold); box-shadow: 0 10px 30px var(--shadow-color); width: 100%; max-width: 800px; box-sizing: border-box; }
        h1 { font-family: 'Cinzel', serif; color: var(--gold); font-size: clamp(1.8rem, 5vw, 2.8rem); margin: 0; text-transform: uppercase; letter-spacing: clamp(1px, 2vw, 3px); text-shadow: 0 2px 10px var(--shadow-color); }
        h2 { font-size: clamp(0.75rem, 2vw, 0.9rem); color: var(--text-muted); font-weight: 400; margin: 5px 0 10px 0; letter-spacing: 0.5px; text-transform: uppercase; }
        
        .info-panel { grid-column: span 12; display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; background: var(--glass-header); border-radius: 12px; padding: 15px; border: 1px solid var(--gold); gap: 15px; box-shadow: 0 4px 10px var(--shadow-color); }
        .date-box { text-align: center; min-width: 100px; flex: 1; }
        .date-label { color: var(--gold-dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
        .date-val { font-size: clamp(1rem, 3vw, 1.2rem); font-weight: bold; color: var(--text-main); }
        #live-clock { font-size: clamp(1.4rem, 4vw, 1.8rem); font-family: 'Courier New', monospace; color: var(--text-main); }

        #sunnah-banner { display: none; grid-column: span 12; width: 100%; box-sizing: border-box; background: rgba(46, 204, 113, 0.15); border: 1px solid var(--success); padding: 10px 20px; border-radius: 12px; text-align: center; color: var(--success); font-weight: bold; letter-spacing: 1px; box-shadow: 0 4px 10px var(--shadow-color); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }

        .prayer-hero { text-align: center; position: relative; transition: all 0.5s ease; width: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 30px 20px; box-sizing: border-box; min-height: 320px; }
        .prayer-name-display { font-size: clamp(2.5rem, 8vw, 3.5rem); color: var(--gold); font-weight: 800; line-height: 1.1; margin: 10px 0; }
        .countdown-display { font-size: clamp(1.8rem, 6vw, 2.2rem); font-family: 'Courier New', monospace; color: var(--text-main); }
        .progress-container { width: 100%; height: 12px; background: var(--progress-bg); margin-top: 20px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border-color); }
        .progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 1s linear; }
        #shuruq-warning { color: var(--danger); font-size: 0.9rem; font-weight: bold; display: none; margin-bottom: 10px; letter-spacing: 1px; }

        .tasbih-circle { width: 140px; height: 140px; border-radius: 50%; background: var(--glass-header); border: 3px solid var(--gold); color: var(--gold); font-size: 3rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 0 4px 15px var(--shadow-color); -webkit-tap-highlight-color: transparent; margin: 10px 0; }
        .tasbih-circle:active { transform: scale(0.92); }
        .tasbih-circle.glow { background: var(--gold); color: #050505; box-shadow: 0 0 30px var(--gold); }

        .btn-gold { background: transparent; border: 2px solid var(--gold); color: var(--gold); padding: 12px 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; text-decoration: none; transition: 0.3s; border-radius: 6px; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; width: 100%; max-width: 300px; box-sizing: border-box; text-align: center; }
        .btn-gold:hover { background: var(--gold); color: #050505; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }

        footer { margin-top: auto; text-align: center; padding: 30px 20px; border-top: 1px solid var(--gold); background: var(--glass-header); width: 100%; box-sizing: border-box; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

        .history-container { display: flex; gap: 20px; flex-wrap: wrap; width: 100%; }
        .history-box { flex: 1 1 300px; padding: 15px; background: var(--glass-header); border-radius: 8px; border: 1px solid var(--gold-dim); box-sizing: border-box; }

        @media (min-width: 768px) {
            .top-left-logo { position: absolute; top: 20px; left: 20px; display: block; margin: 0; }
            html[dir="rtl"] .top-left-logo { left: auto; right: 20px; }
            .prayer-hero, .history-card { grid-column: span 12; }
            .times-card, .tasbih-card, .qibla-card, .tools-card, .text-widget, .dua-widget, .night-widget, .names-widget, .ramadan-widget, .video-card { grid-column: span 6; }
            #install-card-section { grid-column: span 12; }
        }
        @media (min-width: 1024px) {
            /* Perfectly spaced 12-column Grid */
            .prayer-hero { grid-column: span 6; } 
            .times-card { grid-column: span 6; }
            .history-card { grid-column: span 12; }
            .tasbih-card, .qibla-card, .text-widget { grid-column: span 4; } 
            .night-widget, .names-widget, .dua-widget { grid-column: span 4; } 
            .ramadan-widget { grid-column: span 12; } 
            .tools-card, .video-card { grid-column: span 6; } 
            #install-card-section { grid-column: span 12; }
        }
        @media (max-width: 767px) {
            .top-left-logo { position: absolute; top: 15px; left: 15px; width: 50px; }
            .settings-toggle { top: 15px; right: 15px; width: 40px; height: 40px; }
            .focus-toggle { top: 15px; right: 65px; height: 40px; padding: 0 10px; font-size: 0.85rem; }
            .header-section { margin-top: 60px; }
            .info-panel { flex-direction: column; }
            .date-box { width: 100%; padding: 5px 0; border-bottom: 1px solid var(--border-color); }
            .date-box:last-child { border-bottom: none; }
        }

        /* Hide "Get the App" when running as an installed PWA */
        @media all and (display-mode: standalone) {
            #install-card-section { display: none !important; }
        }
    </style>
</head>
<body>

    <audio id="audio-chime" src="audio/chime.mp3" preload="auto"></audio>
    <audio id="audio-default" src="audio/adhan.mp3" preload="auto"></audio>
    <audio id="audio-makkah" src="audio/makkah.mp3" preload="auto"></audio>
    <audio id="audio-madinah" src="audio/madinah.mp3" preload="auto"></audio>
    <audio id="audio-alafasy" src="audio/alafasy.mp3" preload="auto"></audio>

    <button id="focus-btn" class="focus-toggle" aria-label="Focus Mode">üëÅÔ∏è Focus Mode</button>
    <button id="settings-btn" class="settings-toggle" aria-label="Settings">‚öôÔ∏è</button>
    
    <div id="settings-modal" class="modal-overlay">
        <div class="settings-panel">
            <button id="close-settings" class="close-btn" title="Close Settings">√ó</button>
            <h3 data-i18n="pref" style="color:var(--gold); margin-top:0; border-bottom:1px solid var(--gold); padding-bottom:10px;">Preferences</h3>
            
            <div class="setting-group">
                <label>Locations</label>
                <div id="location-list" style="margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px;"></div>
                <div style="display: flex; gap: 5px;">
                    <label for="new-loc-name" style="display: none;">City name (e.g. London)</label>
                    <input type="text" id="new-loc-name" placeholder="City name (e.g. London)" style="flex:1; padding: 8px; border-radius:6px; background:var(--progress-bg); color:var(--text-main); border:1px solid var(--border-color);">
                    <button onclick="addManualLocation()" class="btn-gold" style="width:auto; margin:0; padding: 8px 15px;">Add</button>
                </div>
            </div>

            <div class="setting-group">
                <label data-i18n="lang">Language</label>
                <div class="flex-options">
                    <button class="opt-btn lang-btn" data-lang-val="en">EN</button>
                    <button class="opt-btn lang-btn" data-lang-val="tr">TR</button>
                    <button class="opt-btn lang-btn" data-lang-val="nl">NL</button>
                    <button class="opt-btn lang-btn" data-lang-val="fr">FR</button>
                    <button class="opt-btn lang-btn" data-lang-val="de">DE</button>
                    <button class="opt-btn lang-btn" data-lang-val="es">ES</button>
                    <button class="opt-btn lang-btn" data-lang-val="ar">AR</button>
                </div>
            </div>

            <div class="setting-group">
                <label data-i18n="theme">Theme</label>
                <div class="flex-options">
                    <button class="opt-btn theme-btn" data-theme-val="dark">Dark</button>
                    <button class="opt-btn theme-btn" data-theme-val="light">Light</button>
                    <button class="opt-btn theme-btn" data-theme-val="green">Green</button>
                    <button class="opt-btn theme-btn" data-theme-val="dynamic" data-i18n="dynamic">Dynamic</button>
                </div>
            </div>

            <div class="setting-group">
                <label data-i18n="size">Text Size</label>
                <div class="flex-options">
                    <button class="opt-btn text-btn" data-size-val="small">A-</button>
                    <button class="opt-btn text-btn" data-size-val="normal">A</button>
                    <button class="opt-btn text-btn" data-size-val="large">A+</button>
                </div>
            </div>

            <div class="setting-group">
                <label data-i18n="audio_pref">Audio & Alerts</label>
                <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px;">
                    <div style="display: flex; gap: 5px;">
                        <button class="opt-btn adhan-btn" data-adhan-val="default" style="flex: 1;">Default</button>
                        <button class="preview-btn" onclick="previewAudio('default', this)" title="Play/Stop">‚ñ∂</button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="opt-btn adhan-btn" data-adhan-val="makkah" style="flex: 1;">Makkah</button>
                        <button class="preview-btn" onclick="previewAudio('makkah', this)" title="Play/Stop">‚ñ∂</button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="opt-btn adhan-btn" data-adhan-val="madinah" style="flex: 1;">Madinah</button>
                        <button class="preview-btn" onclick="previewAudio('madinah', this)" title="Play/Stop">‚ñ∂</button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="opt-btn adhan-btn" data-adhan-val="alafasy" style="flex: 1;">Alafasy</button>
                        <button class="preview-btn" onclick="previewAudio('alafasy', this)" title="Play/Stop">‚ñ∂</button>
                    </div>
                    <button class="opt-btn adhan-btn" data-adhan-val="none" style="width: 100%;">None</button>
                </div>
                
                <div class="toggle-row" style="margin-bottom: 8px;">
                    <span data-i18n="wudu_alert" style="font-size: 0.9rem;">10-Min Wudu Alert & Push</span>
                    <label class="switch" style="cursor: pointer; color: var(--gold); font-weight: bold;">
                        <input type="checkbox" id="wudu-toggle" style="accent-color: var(--gold); transform: scale(1.3);">
                        <span style="display:none;">10-Min Wudu Alert & Push toggle</span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label data-i18n="daily_source">Daily Inspiration</label>
                <div class="flex-options">
                    <button class="opt-btn text-source-btn" data-source-val="quran">Ayah</button>
                    <button class="opt-btn text-source-btn" data-source-val="hadith">Hadith</button>
                </div>
            </div>
        </div>
    </div>

    <main class="dashboard-container">
        <img src="images/adhan display muslim prayer times dashboard logo.png" alt="Adhan Display Logo" class="top-left-logo">

        <header class="header-section">
            <div class="title-wrapper">
                <h1>Adhan Display Dashboard</h1>
                <h2 data-i18n="subtitle">The Ultimate Free Islamic Prayer Times & Qibla Dashboard</h2>
                <div style="font-family: 'Times New Roman', serif; font-style: italic; color: var(--text-main); font-size: clamp(0.9rem, 2vw, 1.1rem); border-top: 1px solid var(--border-color); padding-top: 10px;">La ilaha illa Allah, Muhammadur Rasul Allah</div>
            </div>
        </header>

        <section class="info-panel">
            <div class="date-box">
                <div class="date-label" data-i18n="greg">Gregorian</div>
                <div class="date-val" id="greg-date">--/--/----</div>
            </div>
            <div class="date-box">
                <div class="date-label" data-i18n="time">Current Time</div>
                <div class="date-val" id="live-clock">--:--:--</div>
                <div id="weather-display" style="font-size: 0.85rem; color:var(--gold-dim);">Loading...</div>
            </div>
            <div class="date-box">
                <div class="date-label" data-i18n="loc">Location</div>
                <div class="location-val" id="location-name" style="color:var(--text-muted);">Detecting...</div>
            </div>
            <div class="date-box">
                <div class="date-label" data-i18n="hijri">Hijri</div>
                <div class="date-val" id="hijri-date">-- -- ----</div>
            </div>
        </section>

        <div id="sunnah-banner">üåô <span id="sunnah-text">Sunnah Fasting Today</span></div>

        <section id="ramadan-panel" class="card" style="display: none; border-color: var(--success); text-align: center;">
            <div id="fasting-label" style="color:var(--success); text-transform:uppercase; font-size:0.8rem; letter-spacing: 1px; width: 100%;">Fasting Timer</div>
            <div id="fasting-timer" style="font-size: clamp(1.8rem, 5vw, 2.5rem); font-family: 'Courier New', monospace; font-weight: bold; color: var(--text-main); margin-top: 5px; width: 100%;">--:--:--</div>
            <div style="font-size: 0.85rem; color: var(--gold-dim); margin-top: 15px; width: 100%;" id="ashra-label">Ashra: Mercy (Days 1-10)</div>
            <div class="progress-container" style="height: 10px; margin-top: 5px; margin-left: auto; margin-right: auto;">
                <div class="progress-bar" id="ashra-progress-fill" style="background: var(--success); width: 0%;"></div>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; width: 100%;" id="ramadan-day-label">Day -- of 30</div>
        </section>

        <section class="card prayer-hero">
            <div class="date-label" id="status-label" data-i18n="curr">Current Prayer</div>
            <div class="prayer-name-display" id="curr-name">Loading...</div>
            <div id="shuruq-warning" data-i18n="nopray">* Not permissible to pray *</div>
            <div class="prayer-time-display" id="curr-time" style="font-size:1.5rem; color:var(--text-muted);">--:--</div>
            <div style="margin-top: auto; width: 100%;">
                <div class="date-label" id="next-label" data-i18n="next">Next Prayer In</div>
                <div class="countdown-display" id="timer-display">--:--:--</div>
                <div class="progress-container"><div class="progress-bar" id="progress-fill"></div></div>
            </div>
        </section>

        <section class="card times-card">
            <div class="widget-title" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gold); width: 100%; margin: 0 0 10px 0; padding-bottom: 10px;">
                <button onclick="changeTrackerDate(-1)" style="background: transparent; border: none; color: var(--gold); font-size: 1.2rem; cursor: pointer; font-weight: bold;"><</button>
                <div style="text-align: center; line-height: 1.2;">
                    <span data-i18n="daily_times">Daily Prayer Times</span><br>
                    <span id="trackerDate" style="color: var(--text-muted); font-size: 0.75rem; text-transform: none; display: flex; align-items: center; justify-content: center; gap: 8px;">--/--/----</span>
                </div>
                <button onclick="changeTrackerDate(1)" style="background: transparent; border: none; color: var(--gold); font-size: 1.2rem; cursor: pointer; font-weight: bold;">></button>
            </div>
            <div class="progress-container" style="height: 4px; margin-bottom: 15px; border: none; background: var(--progress-bg);"><div class="progress-bar" id="daily-progress-fill" style="background: var(--gold); width: 0%;"></div></div>
            <div id="daily-times-list" style="width: 100%; display: flex; flex-direction: column;">
                <div style="text-align: center; color: var(--text-muted); font-size: 0.9rem;">Loading times...</div>
            </div>
        </section>

        <section class="card history-card" style="width: 100%;">
            <div class="widget-title" style="width: 100%;" data-i18n="tracker_title">Prayer Tracker & History</div>
            <div class="history-container">
                <div class="history-box">
                    <p style="margin: 0 0 15px 0; font-size: 1.1rem; text-align: center;"><strong data-i18n="streak">Current Streak:</strong> <span id="streakCount" style="color: var(--gold); font-weight: bold; font-size: 1.3rem;">0</span> <span title="Perfect Days (5/5) in a row">üî•</span></p>

                    <p style="margin: 0 0 5px 0; font-size: 0.95rem;"><strong data-i18n="last_7">Last 7 Days:</strong> <span id="weekScore" style="color: var(--gold); font-weight: bold;">0</span> / <span id="weekTotal">0</span></p>
                    <div class="progress-container" style="margin-top: 5px; margin-bottom: 20px; border-color: var(--border-color);"><div class="progress-bar" id="weekBar" style="background: var(--success);"></div></div>
                    
                    <p style="margin: 0 0 5px 0; font-size: 0.95rem;"><strong data-i18n="last_30">Last 30 Days:</strong> <span id="monthScore" style="color: var(--gold); font-weight: bold;">0</span> / <span id="monthTotal">0</span></p>
                    <div class="progress-container" style="margin-top: 5px; margin-bottom: 10px; border-color: var(--border-color);"><div class="progress-bar" id="monthBar" style="background: var(--success);"></div></div>
                </div>

                <div class="history-box">
                    <h3 style="margin-top: 0; font-size: 1rem; color: var(--gold); border-bottom: 1px solid var(--gold-dim); padding-bottom: 8px;" data-i18n="past_days">Past Days</h3>
                    <div id="historyLog" style="max-height: 140px; overflow-y: auto; padding-right: 10px; font-size: 0.95rem;">
                        <div style="color: var(--text-muted); text-align: center; margin-top: 20px; font-style: italic;">Loading...</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card tasbih-card">
            <div class="widget-title" data-i18n="tasbih">Digital Tasbih</div>
            <div style="display:flex; flex-direction:column; align-items:center; justify-content: center; height: 100%;">
                <button id="tasbih-btn" class="tasbih-circle" onclick="incrementTasbih()">0</button>
                <button onclick="resetTasbih()" style="margin-top:15px; background:none; border:none; color:var(--text-muted); cursor:pointer; text-decoration:underline; font-size: 0.9rem;">Reset</button>
            </div>
        </section>

        <section class="card qibla-card">
            <div class="widget-title" data-i18n="qibla">Qibla Direction</div>
            <div id="qibla-degree" style="font-size:3rem; font-weight:bold; color:var(--text-main); margin: 20px 0;">--¬∞</div>
            <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom: 20px;" data-i18n="north">from true North</div>
            <a href="https://qiblafinder.withgoogle.com/" target="_blank" class="btn-gold" data-i18n="ar_find">üß≠ Open Qibla Compass</a>
        </section>

        <article class="card text-widget">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; border-bottom: 1px solid var(--gold); padding-bottom: 5px; margin-bottom: 15px;">
                <span style="width: 24px;"></span>
                <span class="widget-title" id="daily-title" data-i18n="ayah" style="border: none; margin: 0; padding: 0;">Ayah of the Day</span>
                <a href="https://quran.com" target="_blank" style="text-decoration: none; font-size: 0.95rem; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: transform 0.2s; color: var(--gold);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="Read on Quran.com">üìñ [Quran.com]</a>
            </div>
            <div id="daily-text" style="font-style:italic; text-align:center; color:var(--text-main); font-size: 1.1rem; line-height: 1.5; padding: 10px 0;">Loading...</div>
            <div id="daily-ref" style="color:var(--gold); font-size:0.8rem; margin-top:10px; width:100%; text-align:right;"></div>
        </article>

        <section class="card night-widget">
            <div class="widget-title" data-i18n="qiyam">Night Prayers (Qiyam)</div>
            <div style="display:flex; justify-content:space-around; width:100%;">
                <div style="text-align:center;"><div id="midnight-time" style="font-size:1.3rem; color:var(--gold);">--:--</div><div style="font-size:0.7rem; color:var(--text-muted);" data-i18n="mid">Midnight</div></div>
                <div style="text-align:center;"><div id="last-third-time" style="font-size:1.3rem; color:var(--gold);">--:--</div><div style="font-size:0.7rem; color:var(--text-muted);" data-i18n="tahajjud">Tahajjud</div></div>
            </div>
        </section>

        <article class="card names-widget">
            <div class="widget-title" data-i18n="allah">Name of Allah</div>
            <div id="allah-ar" style="font-size:2.2rem; color:var(--gold); font-family: 'Tajawal', sans-serif;">--</div>
            <div id="allah-en" style="font-weight:bold; color:var(--text-main);">--</div>
            <div id="allah-meaning" style="font-size:0.8rem; font-style:italic; color:var(--text-muted); text-align: center;">--</div>
        </article>

        <article class="card dua-widget">
            <div style="display: flex; justify-content: center; align-items: center; width: 100%; border-bottom: 1px solid var(--gold); padding-bottom: 5px; margin-bottom: 15px;">
                <span class="widget-title" data-i18n="dua" style="border: none; margin: 0; padding: 0;">Dua of the Day</span>
            </div>
            <div id="dua-text" style="font-style:italic; text-align:center; color:var(--text-main); font-size: 1.1rem; line-height: 1.5; padding: 10px 0;">Loading...</div>
            <div id="dua-ref" style="color:var(--gold); font-size:0.8rem; margin-top:10px; width:100%; text-align:right;"></div>
        </article>

        <article class="card ramadan-widget" id="ramadan-countdown-container">
            <div class="widget-title" data-i18n="ramadan">Ramadan</div>
            <div id="ramadan-val" style="font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: bold;">--</div>
            <div style="font-size:0.8rem; color:var(--gold-dim);" data-i18n="days">Days Remaining</div>
        </article>

        <section class="card tools-card">
            <div class="widget-title" data-i18n="resources">Tools & Resources</div>
            <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
                <a href="https://www.myprayer.org/pages/my-prayer-book" target="_blank" class="btn-gold" style="max-width: 100%;">üìñ <span data-i18n="revert_guide">Step-by-Step Prayer Guide</span></a>
                <div style="display: flex; gap: 10px; width: 100%;">
                    <a href="https://apps.apple.com/us/app/namaz-app-learn-salah-prayer/id1447056625" target="_blank" class="btn-gold" style="flex: 1; max-width: 100%; font-size: 0.8rem;">üì± Namaz App (iOS)</a>
                    <a href="https://play.google.com/store/apps/details?id=com.nurios.namazapp" target="_blank" class="btn-gold" style="flex: 1; max-width: 100%; font-size: 0.8rem;">üì± Namaz App (Android)</a>
                </div>
                <a href="https://www.zakat.org/resource-center/zakat-calculator" target="_blank" class="btn-gold" style="max-width: 100%;">üßÆ <span data-i18n="zakat_calc">Zakat Calculator</span></a>
            </div>
        </section>

        <section class="card video-card">
            <div class="widget-title" data-i18n="live_stream">Holy Sites Live</div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; width: 100%;">
                <button class="opt-btn active" id="btn-makkah" onclick="setStream('makkah')" style="flex: 1;">Makkah</button>
                <button class="opt-btn" id="btn-madinah" onclick="setStream('madinah')" style="flex: 1;">Madinah</button>
            </div>
            <a id="stream-link" href="https://www.youtube.com/results?search_query=makkah+live" target="_blank" class="btn-gold">
                <span style="height: 10px; width: 10px; background-color: var(--danger); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--danger);"></span> 
                <span data-i18n="watch">Watch Stream</span>
            </a>
        </section>

        <section id="install-card-section" class="card install-card" style="padding: 30px;">
            <div class="widget-title" style="margin-bottom: 5px; border: none;" data-i18n="getapp">Get the App</div>
            <button id="install-btn" class="btn-gold" style="width: auto; padding: 12px 40px; border-radius: 50px;" data-i18n="install">Install App</button>
        </section>

    </main>

    <footer>
        <img src="images/adhan display muslim prayer times dashboard logo.png" alt="Logo" class="footer-logo" style="width: 80px; height: auto; opacity: 0.8; margin-bottom: 10px;">
        <p style="font-size: 0.8rem; color: var(--text-muted);">¬© 2026 Adhan Display. Serving the Ummah.</p>
        
        <div style="margin-top: 15px;">
            <a href="https://buymeacoffee.com/kmni" target="_blank" style="text-decoration: none;">
                <button class="btn-gold" style="padding: 10px 25px; font-size: 0.85rem; border-radius: 50px; text-transform: none; display: inline-flex; width: auto; font-weight: bold; box-shadow: 0 4px 10px var(--shadow-color);">
                    ‚òï Donate to keep this app ad-free
                </button>
            </a>
        </div>
        <div style="text-align: center; padding: 20px 10px 30px; font-family: 'Cinzel', serif; color: inherit; opacity: 0.8;">
            <a href="https://instagram.com/adhandisplay" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/>
                </svg>
                Follow us on Instagram @adhandisplay
            </a>
        </div>
    </footer>

    <script>
        // === TRANSLATIONS (i18n) ===
        const i18n = {
            en: { subtitle: "The Ultimate Free Islamic Prayer Times & Qibla Dashboard", greg: "Gregorian", time: "Current Time", loc: "Location", hijri: "Hijri", curr: "Current Prayer", next: "Next Prayer In", ayah: "Ayah of the Day", hadith: "Hadith of the Day", dua: "Dua of the Day", qiyam: "Night Prayers", mid: "Midnight", tahajjud: "Tahajjud", allah: "Name of Allah", ramadan: "Ramadan", days: "Days Remaining", makkah: "Makkah Live", live_stream: "Holy Sites Live", watch: "Watch Stream", qibla: "Qibla Direction", north: "from true North", ar_find: "üß≠ Open Qibla Compass", getapp: "Get the App", install: "Install App", pref: "Preferences", theme: "Theme", dynamic: "Dynamic", size: "Text Size", lang: "Language", nopray: "* Not permissible to pray *", audio_pref: "Audio & Alerts", wudu_alert: "10-Min Wudu Alert & Push", daily_source: "Daily Inspiration", sunnah_mon: "Sunnah Fasting: Monday", sunnah_thu: "Sunnah Fasting: Thursday", sunnah_white: "Sunnah Fasting: Ayyam al-Bid (White Days)", daily_times: "Daily Prayer Times", tracker_title: "Prayer Tracker & History", streak: "Current Streak:", last_7: "Last 7 Days:", last_30: "Last 30 Days:", past_days: "Past Days", no_data: "No past data yet.", tasbih: "Digital Tasbih", resources: "Tools & Resources", revert_guide: "Step-by-Step Prayer Guide", zakat_calc: "Zakat Calculator" },
            tr: { subtitle: "En ƒ∞yi √úcretsiz ƒ∞slami Namaz Vakitleri Panosu", greg: "Miladi", time: "≈ûu Anki Saat", loc: "Konum", hijri: "Hicri", curr: "Mevcut Namaz", next: "Sonraki Namaz", ayah: "G√ºn√ºn Ayeti", hadith: "G√ºn√ºn Hadisi", dua: "G√ºn√ºn Duasƒ±", qiyam: "Gece Namazlarƒ±", mid: "Gece Yarƒ±sƒ±", tahajjud: "Tehecc√ºd", allah: "Allah'ƒ±n ƒ∞smi", ramadan: "Ramazan", days: "Kalan G√ºn", makkah: "Mekke Canlƒ±", live_stream: "Kutsal Yerler Canlƒ±", watch: "Yayƒ±nƒ± ƒ∞zle", qibla: "Kƒ±ble Y√∂n√º", north: "Ger√ßek Kuzeyden", ar_find: "üß≠ Kƒ±ble Pusulasƒ±nƒ± A√ß", getapp: "Uygulamayƒ± Al", install: "Uygulamayƒ± Y√ºkle", pref: "Tercihler", theme: "Tema", dynamic: "Dinamik", size: "Metin Boyutu", lang: "Dil", nopray: "* Namaz Kƒ±lmak Mekruhtur *", audio_pref: "Ses ve Uyarƒ±lar", wudu_alert: "10-Dk Abdest Uyarƒ±sƒ±", daily_source: "G√ºnl√ºk ƒ∞lham", sunnah_mon: "S√ºnnet Orucu: Pazartesi", sunnah_thu: "S√ºnnet Orucu: Per≈üembe", sunnah_white: "S√ºnnet Orucu: Eyyam-ƒ± B√Æd (Beyaz G√ºnler)", daily_times: "G√ºnl√ºk Namaz Vakitleri", tracker_title: "Namaz Takibi ve Ge√ßmi≈ü", streak: "Mevcut Seri:", last_7: "Son 7 G√ºn:", last_30: "Son 30 G√ºn:", past_days: "Ge√ßmi≈ü G√ºnler", no_data: "Hen√ºz veri yok.", tasbih: "Dijital Tesbih", resources: "Ara√ßlar ve Kaynaklar", revert_guide: "Adƒ±m Adƒ±m Namaz Rehberi", zakat_calc: "Zekat Hesaplayƒ±cƒ±" },
            nl: { subtitle: "Het Ultieme Islamitische Gebedstijden Dashboard", greg: "Gregoriaans", time: "Huidige Tijd", loc: "Locatie", hijri: "Hidzjra", curr: "Huidig Gebed", next: "Volgend Gebed In", ayah: "Vers van de Dag", hadith: "Hadith van de Dag", dua: "Smeekbede van de Dag", qiyam: "Nachtgebeden", mid: "Middernacht", tahajjud: "Tahajjud", allah: "Naam van Allah", ramadan: "Ramadan", days: "Dagen Te Gaan", makkah: "Mekka Live", live_stream: "Heilige Plaatsen Live", watch: "Bekijk Stream", qibla: "Qibla Richting", north: "van ware noorden", ar_find: "üß≠ Open Qibla Kompas", getapp: "Download de App", install: "Installeer App", pref: "Instellingen", theme: "Thema", dynamic: "Dynamisch", size: "Tekstgrootte", lang: "Taal", nopray: "* Bidden is niet toegestaan *", audio_pref: "Audio & Meldingen", wudu_alert: "10-Min Wudu Melding", daily_source: "Dagelijkse Inspiratie", sunnah_mon: "Sunnah Vasten: Maandag", sunnah_thu: "Sunnah Vasten: Donderdag", sunnah_white: "Sunnah Vasten: Witte Dagen", daily_times: "Dagelijkse Gebedstijden", tracker_title: "Gebedstracker & Geschiedenis", streak: "Huidige Reeks:", last_7: "Laatste 7 Dagen:", last_30: "Laatste 30 Dagen:", past_days: "Verleden Dagen", no_data: "Nog geen data.", tasbih: "Digitale Tasbih", resources: "Tools & Hulpbronnen", revert_guide: "Stap-voor-Stap Gebedsgids", zakat_calc: "Zakat Calculator" },
            fr: { subtitle: "Le Tableau de Bord Islamique Ultime", greg: "Gr√©gorien", time: "Heure Actuelle", loc: "Emplacement", hijri: "H√©gire", curr: "Pri√®re Actuelle", next: "Prochaine Pri√®re", ayah: "Verset du Jour", hadith: "Hadith du Jour", dua: "Dua du Jour", qiyam: "Pri√®res Nocturnes", mid: "Minuit", tahajjud: "Tahajjud", allah: "Nom d'Allah", ramadan: "Ramadan", days: "Jours Restants", makkah: "Mecque en Direct", live_stream: "Lieux Saints en Direct", watch: "Regarder le Stream", qibla: "Direction de la Qibla", north: "du vrai nord", ar_find: "üß≠ Ouvrir la Boussole Qibla", getapp: "Obtenir l'App", install: "Installer l'App", pref: "Pr√©f√©rences", theme: "Th√®me", dynamic: "Dynamique", size: "Taille du Texte", lang: "Langue", nopray: "* Pri√®re non permise *", audio_pref: "Audio & Alertes", wudu_alert: "Alerte Wudu 10-Min", daily_source: "Inspiration Quotidienne", sunnah_mon: "Je√ªne Sunnah : Lundi", sunnah_thu: "Je√ªne Sunnah : Jeudi", sunnah_white: "Je√ªne Sunnah : Jours Blancs", daily_times: "Heures de Pri√®re", tracker_title: "Suivi des Pri√®res", streak: "S√©rie Actuelle:", last_7: "7 Derniers Jours:", last_30: "30 Derniers Jours:", past_days: "Jours Pass√©s", no_data: "Aucune donn√©e.", tasbih: "Tasbih Num√©rique", resources: "Outils et Ressources", revert_guide: "Guide de Pri√®re √âtape par √âtape", zakat_calc: "Calculatrice de Zakat" },
            de: { subtitle: "Das Ultimative Islamische Dashboard", greg: "Gregorianisch", time: "Aktuelle Zeit", loc: "Ort", hijri: "Hidschra", curr: "Aktuelles Gebet", next: "N√§chstes Gebet In", ayah: "Vers des Tages", hadith: "Hadith des Tages", dua: "Dua des Tages", qiyam: "Nachtgebete", mid: "Mitternacht", tahajjud: "Tahajjud", allah: "Name Allahs", ramadan: "Ramadan", days: "Verbleibende Tage", makkah: "Mekka Live", live_stream: "Heilige St√§tten Live", watch: "Stream Ansehen", qibla: "Qibla-Richtung", north: "vom wahren Norden", ar_find: "üß≠ Qibla-Kompass √ñffnen", getapp: "App Holen", install: "App Installieren", pref: "Einstellungen", theme: "Thema", dynamic: "Dynamisch", size: "Textgr√∂√üe", lang: "Sprache", nopray: "* Beten ist nicht erlaubt *", audio_pref: "Audio & Warnungen", wudu_alert: "10-Min Wudu-Alarm", daily_source: "T√§gliche Inspiration", sunnah_mon: "Sunnah Fasten: Montag", sunnah_thu: "Sunnah Fasten: Donnerstag", sunnah_white: "Sunnah Fasten: Wei√üe Tage", daily_times: "T√§gliche Gebetszeiten", tracker_title: "Gebets-Tracker", streak: "Aktuelle Serie:", last_7: "Letzte 7 Tage:", last_30: "Letzte 30 Tage:", past_days: "Vergangene Tage", no_data: "Noch keine Daten.", tasbih: "Digitaler Tasbih", resources: "Werkzeuge & Ressourcen", revert_guide: "Schritt-f√ºr-Schritt Gebetsanleitung", zakat_calc: "Zakat Rechner" },
            es: { subtitle: "El Panel de Oraci√≥n Isl√°mica Definitivo", greg: "Gregoriano", time: "Hora Actual", loc: "Ubicaci√≥n", hijri: "H√©gira", curr: "Oraci√≥n Actual", next: "Pr√≥xima Oraci√≥n En", ayah: "Vers√≠culo del D√≠a", hadith: "Hadiz del D√≠a", dua: "Dua del D√≠a", qiyam: "Oraciones Nocturnas", mid: "Medianoche", tahajjud: "Tahajjud", allah: "Nombre de Al√°", ramadan: "Ramad√°n", days: "D√≠as Restantes", makkah: "La Meca en Vivo", live_stream: "Lugares Santos en Vivo", watch: "Ver Transmisi√≥n", qibla: "Direcci√≥n Qibla", north: "desde el norte", ar_find: "üß≠ Abrir Br√∫jula Qibla", getapp: "Obtener App", install: "Instalar App", pref: "Preferencias", theme: "Tema", dynamic: "Din√°mico", size: "Tama√±o", lang: "Idioma", nopray: "* No est√° permitido orar *", audio_pref: "Audio y Alertas", wudu_alert: "Alerta Wudu 10-Min", daily_source: "Inspiraci√≥n Diaria", sunnah_mon: "Ayuno Sunnah: Lunes", sunnah_thu: "Ayuno Sunnah: Jueves", sunnah_white: "Ayuno Sunnah: D√≠as Blancos", daily_times: "Horarios de Oraci√≥n", tracker_title: "Rastreador de Oraciones", streak: "Racha Actual:", last_7: "√öltimos 7 D√≠as:", last_30: "√öltimos 30 D√≠as:", past_days: "D√≠as Pasados", no_data: "A√∫n no hay datos.", tasbih: "Tasbih Digital", resources: "Herramientas y Recursos", revert_guide: "Gu√≠a de Oraci√≥n Paso a Paso", zakat_calc: "Calculadora de Zakat" },
            ar: { subtitle: "ŸÑŸàÿ≠ÿ© ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸäÿ© ÿßŸÑŸÖÿ∑ŸÑŸÇÿ©", greg: "ŸÖŸäŸÑÿßÿØŸä", time: "ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä", loc: "ÿßŸÑŸÖŸàŸÇÿπ", hijri: "Ÿáÿ¨ÿ±Ÿä", curr: "ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©", next: "ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸÇÿßÿØŸÖÿ© ŸÅŸä", ayah: "ÿ¢Ÿäÿ© ÿßŸÑŸäŸàŸÖ", hadith: "ÿ≠ÿØŸäÿ´ ÿßŸÑŸäŸàŸÖ", dua: "ÿØÿπÿßÿ° ÿßŸÑŸäŸàŸÖ", qiyam: "ŸÇŸäÿßŸÖ ÿßŸÑŸÑŸäŸÑ", mid: "ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ", tahajjud: "ÿ™Ÿáÿ¨ÿØ", allah: "ÿßÿ≥ŸÖ ÿßŸÑŸÑŸá", ramadan: "ÿ±ŸÖÿ∂ÿßŸÜ", days: "ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ®ŸÇŸäÿ©", makkah: "ŸÖŸÉÿ© ŸÖÿ®ÿßÿ¥ÿ±", live_stream: "ÿßŸÑÿ®ÿ´ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± ŸÑŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÖŸÇÿØÿ≥ÿ©", watch: "ÿ¥ÿßŸáÿØ ÿßŸÑÿ®ÿ´", qibla: "ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÇÿ®ŸÑÿ©", north: "ŸÖŸÜ ÿßŸÑÿ¥ŸÖÿßŸÑ ÿßŸÑÿ≠ŸÇŸäŸÇŸä", ar_find: "üß≠ ŸÅÿ™ÿ≠ ÿ®ŸàÿµŸÑÿ© ÿßŸÑŸÇÿ®ŸÑÿ©", getapp: "ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ", install: "ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ", pref: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™", theme: "ÿßŸÑÿ≥ŸÖÿ©", dynamic: "ÿØŸäŸÜÿßŸÖŸäŸÉŸä", size: "ÿ≠ÿ¨ŸÖ ÿßŸÑŸÜÿµ", lang: "ÿßŸÑŸÑÿ∫ÿ©", nopray: "* ÿßŸÑÿµŸÑÿßÿ© ÿ∫Ÿäÿ± ÿ¨ÿßÿ¶ÿ≤ÿ© *", audio_pref: "ÿßŸÑÿµŸàÿ™ ŸàÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™", wudu_alert: "ÿ™ŸÜÿ®ŸäŸá ÿßŸÑŸàÿ∂Ÿàÿ° 10 ÿØŸÇÿßÿ¶ŸÇ", daily_source: "ÿ•ŸÑŸáÿßŸÖ ŸäŸàŸÖŸä", sunnah_mon: "ÿµŸäÿßŸÖ ÿßŸÑÿ≥ŸÜÿ©: ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ", sunnah_thu: "ÿµŸäÿßŸÖ ÿßŸÑÿ≥ŸÜÿ©: ÿßŸÑÿÆŸÖŸäÿ≥", sunnah_white: "ÿµŸäÿßŸÖ ÿßŸÑÿ≥ŸÜÿ©: ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑÿ®Ÿäÿ∂", daily_times: "ŸÖŸàÿßŸÇŸäÿ™ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸäŸàŸÖŸäÿ©", tracker_title: "ŸÖÿ™ÿ™ÿ®ÿπ ÿßŸÑÿµŸÑÿßÿ©", streak: "ÿßŸÑÿ≥ŸÑÿ≥ŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:", last_7: "ÿ¢ÿÆÿ± 7 ÿ£ŸäÿßŸÖ:", last_30: "ÿ¢ÿÆÿ± 30 ŸäŸàŸÖ:", past_days: "ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿßÿ∂Ÿäÿ©", no_data: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ.", tasbih: "ŸÖÿ≥ÿ®ÿ≠ÿ© ÿ±ŸÇŸÖŸäÿ©", resources: "ÿßŸÑÿ£ÿØŸàÿßÿ™ ŸàÿßŸÑŸÖŸàÿßÿ±ÿØ", revert_guide: "ÿØŸÑŸäŸÑ ÿßŸÑÿµŸÑÿßÿ© ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©", zakat_calc: "ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑÿ≤ŸÉÿßÿ©" }
        };

        const dailyHadiths = [
            { text: "He who does not show mercy to people, Allah will not show mercy to him.", ref: "Sahih Muslim 2319" },
            { text: "The most beloved of deeds to Allah are those that are most consistent, even if it is small.", ref: "Sahih al-Bukhari 6464" },
            { text: "Make things easy for the people, and do not make it difficult for them...", ref: "Sahih al-Bukhari 69" },
            { text: "A good word is charity.", ref: "Sahih al-Bukhari 2989" },
            { text: "Richness is not having many possessions, but richness is being content with oneself.", ref: "Sahih al-Bukhari 6446" },
            { text: "None of you truly believes until he loves for his brother what he loves for himself.", ref: "Sahih al-Bukhari 13" },
            { text: "The strong man is not the good wrestler, but the strong man is he who controls himself when he is angry.", ref: "Sahih al-Bukhari 6114" },
            { text: "Every religion has its distinct characteristic, and the distinct characteristic of Islam is modesty.", ref: "Ibn Majah" }
        ];

        const dailyDuas = [
            { text: "Rabbi inni lima anzalta ilayya min khayrin faqir\n(My Lord, I am in absolute need of the good You send me.)", ref: "Quran 28:24" },
            { text: "Rabbana atina fid-dunya hasanatan wa fil 'akhirati hasanatan waqina 'adhaban-nar\n(Our Lord, give us in this world what is good and in the Hereafter what is good and protect us from the punishment of the Fire.)", ref: "Quran 2:201" },
            { text: "Ya Muqallibal-qulub, thabbit qalbi 'ala dinik\n(O Turner of the hearts, keep my heart firm upon Your religion.)", ref: "Tirmidhi" },
            { text: "Rabbi zidni 'ilma\n(My Lord, increase me in knowledge.)", ref: "Quran 20:114" },
            { text: "Astaghfirullahal-ladhi la ilaha illa Huwal-Hayyul-Qayyum wa atubu ilayh\n(I seek the forgiveness of Allah, there is no true god except Him, the Ever-Living, the Sustainer of existence, and I turn to Him in repentance.)", ref: "Tirmidhi" },
            { text: "Rabbighfir warham wa anta khayrur-rahimin\n(My Lord, forgive and have mercy, and You are the best of the merciful.)", ref: "Quran 23:118" },
            { text: "HasbiyAllahu la ilaha illa Huwa 'alayhi tawakkaltu wa Huwa Rabbul-'Arshil-'Adhim\n(Allah is sufficient for me. There is no true god but Him, in Him I put my trust, and He is the Lord of the Great Throne.)", ref: "Abu Dawud" },
            { text: "Allahumma inni as'aluka 'ilman nafi'an, wa rizqan tayyiban, wa 'amalan mutaqabbalan\n(O Allah, I ask You for beneficial knowledge, goodly provision and acceptable deeds.)", ref: "Ibn Majah" }
        ];

        let config = { lat: 52.0907, lon: 5.1214, city: 'Netherlands', method: 3 };
        let state = { prayers: {}, nextPrayer: null, prevPrayerTime: null, namesList: [], isRamadan: false, notified10Min: false, adhanPlayed: false };
        let wakeLock = null;
        let isAutoLoc = localStorage.getItem('adhan_auto_loc') !== 'false'; // Defaults to true
        let autoLocationInterval = null;

        // === WAKE LOCK API LOGIC (ALWAYS ON) ===
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => { console.log('Screen Wake Lock released'); });
                } catch (err) { console.error(`${err.name}, ${err.message}`); }
            }
        }
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') requestWakeLock();
        });

        // === MODALS & FOCUS MODE LOGIC ===
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings');
        const settingsModal = document.getElementById('settings-modal');
        const focusBtn = document.getElementById('focus-btn');

        settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
        focusBtn.addEventListener('click', () => document.body.classList.toggle('focus-mode'));

        function applySettings() {
            const theme = localStorage.getItem('adhan_theme') || 'light'; // Light mode is default!
            const lang = localStorage.getItem('adhan_lang') || 'en';
            const size = localStorage.getItem('adhan_size') || 'normal';
            const audio = localStorage.getItem('adhan_audio') || 'default';
            const source = localStorage.getItem('adhan_daily') || 'quran';
            const wudu = localStorage.getItem('adhan_wudu') === 'true';

            document.documentElement.setAttribute('data-theme', theme);
            if (theme !== 'dynamic') document.documentElement.removeAttribute('data-time-of-day');

            let rootSize = '16px';
            if (size === 'small') rootSize = '14px';
            if (size === 'large') rootSize = '18px';
            document.documentElement.style.fontSize = rootSize;

            document.getElementById('wudu-toggle').checked = wudu;

            // Set dynamic title for Ayah/Hadith widget
            if(source === 'hadith') {
                document.getElementById('daily-title').setAttribute('data-i18n', 'hadith');
            } else {
                document.getElementById('daily-title').setAttribute('data-i18n', 'ayah');
            }

            document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.themeVal === theme));
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.langVal === lang));
            document.querySelectorAll('.text-btn').forEach(b => b.classList.toggle('active', b.dataset.sizeVal === size));
            document.querySelectorAll('.adhan-btn').forEach(b => b.classList.toggle('active', b.dataset.adhanVal === audio));
            document.querySelectorAll('.text-source-btn').forEach(b => b.classList.toggle('active', b.dataset.sourceVal === source));

            applyTranslations(lang);
        }

        function applyTranslations(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) el.innerText = i18n[lang][key];
                else if (i18n['en'][key]) el.innerText = i18n['en'][key];
            });
        }

        document.querySelectorAll('.theme-btn').forEach(btn => btn.addEventListener('click', (e) => { localStorage.setItem('adhan_theme', e.target.dataset.themeVal); applySettings(); updateDynamicTheme(); }));
        document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => { localStorage.setItem('adhan_lang', e.target.dataset.langVal); applySettings(); fetchContent(); }));
        document.querySelectorAll('.text-btn').forEach(btn => btn.addEventListener('click', (e) => { localStorage.setItem('adhan_size', e.target.dataset.sizeVal); applySettings(); }));
        document.querySelectorAll('.adhan-btn').forEach(btn => btn.addEventListener('click', (e) => { localStorage.setItem('adhan_audio', e.target.dataset.adhanVal); applySettings(); }));
        document.querySelectorAll('.text-source-btn').forEach(btn => btn.addEventListener('click', (e) => { localStorage.setItem('adhan_daily', e.target.dataset.sourceVal); applySettings(); fetchContent(); }));
        
        document.getElementById('wudu-toggle').addEventListener('change', (e) => { 
            localStorage.setItem('adhan_wudu', e.target.checked); 
            if (e.target.checked && "Notification" in window) Notification.requestPermission();
        });

        // Hide App Install section if already running as standalone PWA
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            document.getElementById('install-card-section').style.display = 'none';
        }

        // Install button functionality 
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { 
            e.preventDefault(); 
            deferredPrompt = e; 
        });

        const isIos = () => { return /iphone|ipad|ipod/.test( window.navigator.userAgent.toLowerCase() ); };

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) { 
                deferredPrompt.prompt(); 
                deferredPrompt = null; 
            } else if (isIos()) { 
                alert("To install on iOS: Tap the 'Share' icon at the bottom of Safari, scroll down, and select 'Add to Home Screen'."); 
            } else { 
                alert("Tap your browser's menu (‚ãÆ) and select 'Install' or 'Add to Home Screen'."); 
            }
        });

        // === SMART CACHE ===
        async function fetchCached(key, url, ttlHours) {
            const cached = localStorage.getItem(key);
            if (cached) {
                const parsed = JSON.parse(cached);
                if (Date.now() - parsed.timestamp < ttlHours * 3600000) return parsed.data;
            }
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Network error");
                const data = await res.json();
                localStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), data }));
                return data;
            } catch (e) {
                if (cached) return JSON.parse(cached).data;
                return null;
            }
        }

        // === MULTI-LOCATION & AUTO-LOCATION SYSTEM ===
        let savedLocs = JSON.parse(localStorage.getItem('adhan_saved_locs')) || [];
        
        function renderLocations() {
            const container = document.getElementById('location-list');
            container.innerHTML = '';

            // Add Auto Detect Button
            const autoRow = document.createElement('div');
            autoRow.style.display = 'flex'; autoRow.style.gap = '5px'; autoRow.style.marginBottom = '5px';
            const btnAuto = document.createElement('button');
            btnAuto.className = 'opt-btn' + (isAutoLoc ? ' active' : '');
            btnAuto.innerText = 'üìç Auto Detect'; btnAuto.style.flex = '1';
            btnAuto.onclick = window.enableAutoLocation;
            autoRow.appendChild(btnAuto);
            container.appendChild(autoRow);

            // Add Saved Locations
            savedLocs.forEach((loc, index) => {
                const row = document.createElement('div');
                row.style.display = 'flex'; row.style.gap = '5px';
                
                const btnName = document.createElement('button');
                btnName.className = 'opt-btn' + ((!isAutoLoc && config.city === loc.name) ? ' active' : '');
                btnName.innerText = loc.name; btnName.style.flex = '1';
                btnName.onclick = () => { selectLocation(index); };
                
                const btnEdit = document.createElement('button');
                btnEdit.className = 'opt-btn'; btnEdit.innerText = '‚úèÔ∏è'; btnEdit.title = "Edit Name";
                btnEdit.style.flex = '0 0 auto'; btnEdit.style.padding = '8px';
                btnEdit.onclick = () => { editLocation(index); };

                const btnDel = document.createElement('button');
                btnDel.className = 'opt-btn'; btnDel.innerText = 'üóëÔ∏è'; btnDel.title = "Delete Location";
                btnDel.style.flex = '0 0 auto'; btnDel.style.padding = '8px';
                btnDel.onclick = () => { deleteLocation(index); };

                row.appendChild(btnName); row.appendChild(btnEdit); row.appendChild(btnDel);
                container.appendChild(row);
            });
        }

        window.enableAutoLocation = function() {
            isAutoLoc = true;
            localStorage.setItem('adhan_auto_loc', 'true');
            document.getElementById('location-name').innerText = "Detecting...";
            renderLocations();
            detectAndApplyAutoLocation();
            startAutoLocationInterval();
        };
        
        function selectLocation(index) {
            isAutoLoc = false;
            localStorage.setItem('adhan_auto_loc', 'false');
            stopAutoLocationInterval();
            const loc = savedLocs[index];
            config.lat = loc.lat; config.lon = loc.lon; config.city = loc.name;
            document.getElementById('location-name').innerText = config.city;
            fetchWeather(); fetchPrayerData(); renderLocations(); calculateQibla();
        }

        window.editLocation = function(index) {
            const newName = prompt("Enter a new display name for this location:", savedLocs[index].name);
            if(newName && newName.trim() !== "") {
                const wasActive = (!isAutoLoc && config.city === savedLocs[index].name);
                savedLocs[index].name = newName.trim();
                localStorage.setItem('adhan_saved_locs', JSON.stringify(savedLocs));
                if(wasActive) { config.city = savedLocs[index].name; document.getElementById('location-name').innerText = config.city; }
                renderLocations();
            }
        };

        window.deleteLocation = function(index) {
            if(confirm("Are you sure you want to remove '" + savedLocs[index].name + "'?")) {
                const wasActive = (!isAutoLoc && config.city === savedLocs[index].name);
                savedLocs.splice(index, 1);
                localStorage.setItem('adhan_saved_locs', JSON.stringify(savedLocs));
                if(wasActive) window.enableAutoLocation(); // Fallback to auto if deleted active location
                else renderLocations();
            }
        };

        async function addManualLocation() {
            const name = document.getElementById('new-loc-name').value;
            if(!name) return;
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1`);
                const data = await res.json();
                if(data.results && data.results.length > 0) {
                    savedLocs.push({name: data.results[0].name, lat: data.results[0].latitude, lon: data.results[0].longitude});
                    localStorage.setItem('adhan_saved_locs', JSON.stringify(savedLocs));
                    document.getElementById('new-loc-name').value = '';
                    selectLocation(savedLocs.length - 1); // Disables auto and selects this
                } else { alert("Location not found."); }
            } catch(e) { console.error(e); }
        }

        async function detectAndApplyAutoLocation() {
            const data = await fetchCached('adhan_location_auto', 'https://ipapi.co/json/', 2); // Caches for 2 hours
            if(data && data.latitude) { 
                config.lat = data.latitude; config.lon = data.longitude; config.city = data.city || data.country_name; 
                document.getElementById('location-name').innerText = config.city + ' (Auto)';
            }
            fetchWeather(); fetchPrayerData(); calculateQibla();
        }

        function startAutoLocationInterval() {
            if (autoLocationInterval) clearInterval(autoLocationInterval);
            autoLocationInterval = setInterval(() => {
                localStorage.removeItem('adhan_location_auto'); // Clear cache key to force a fresh fetch
                detectAndApplyAutoLocation();
            }, 2 * 60 * 60 * 1000); // 2 hours
        }

        function stopAutoLocationInterval() {
            if (autoLocationInterval) clearInterval(autoLocationInterval);
            autoLocationInterval = null;
        }

        async function initLocation() {
            if (isAutoLoc) {
                await detectAndApplyAutoLocation();
                startAutoLocationInterval();
            } else if (savedLocs.length > 0) {
                let activeIndex = savedLocs.findIndex(l => l.name === config.city);
                if (activeIndex === -1) activeIndex = 0;
                config.lat = savedLocs[activeIndex].lat; config.lon = savedLocs[activeIndex].lon; config.city = savedLocs[activeIndex].name;
                document.getElementById('location-name').innerText = config.city;
                fetchWeather(); fetchPrayerData(); calculateQibla();
            } else {
                window.enableAutoLocation();
            }
            renderLocations();
        }

        function updateDynamicTheme() {
            if (localStorage.getItem('adhan_theme') !== 'dynamic') {
                document.documentElement.removeAttribute('data-time-of-day');
                return;
            }
            let timeOfDay = 'night';
            if (state.nextPrayer) {
                if (state.nextPrayer.name === 'Sunrise') timeOfDay = 'fajr';
                else if (['Dhuhr', 'Asr', 'Maghrib'].includes(state.nextPrayer.name)) timeOfDay = 'day';
                else timeOfDay = 'night';
            }
            document.documentElement.setAttribute('data-time-of-day', timeOfDay);
        }

        // === AUDIO ===
        window.previewAudio = function(type, btnElement) { 
            const audioEl = document.getElementById('audio-' + type);
            const isPlaying = !audioEl.paused;

            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; }); 
            document.querySelectorAll('.preview-btn').forEach(b => { b.innerText = '‚ñ∂'; b.title = 'Play'; });

            if (!isPlaying && audioEl) { 
                audioEl.play().catch(e => console.log(e)); 
                btnElement.innerText = '‚èπ';
                btnElement.title = 'Stop';
                audioEl.onended = () => { btnElement.innerText = '‚ñ∂'; btnElement.title = 'Play'; };
            }
        };

        function playAudio(triggerType) {
            const audioPref = localStorage.getItem('adhan_audio') || 'default';
            if (triggerType === 'adhan' && audioPref !== 'none') {
                const audioEl = document.getElementById('audio-' + audioPref) || document.getElementById('audio-default');
                audioEl.play().catch(e => console.log(e));
            } else if (triggerType === 'chime') { document.getElementById('audio-chime').play().catch(e => console.log(e)); }
        }

        window.setStream = function(type) {
            document.getElementById('btn-makkah').classList.toggle('active', type === 'makkah');
            document.getElementById('btn-madinah').classList.toggle('active', type === 'madinah');
            document.getElementById('stream-link').href = type === 'makkah' 
                ? 'https://www.youtube.com/results?search_query=makkah+live' 
                : 'https://www.youtube.com/results?search_query=madina+live';
        };

        let tasbihCount = 0;
        window.incrementTasbih = function() {
            tasbihCount++; document.getElementById('tasbih-btn').innerText = tasbihCount;
            if (tasbihCount % 33 === 0) {
                if (navigator.vibrate) navigator.vibrate(200);
                document.getElementById('tasbih-btn').classList.add('glow');
                setTimeout(() => document.getElementById('tasbih-btn').classList.remove('glow'), 400);
            }
        };
        window.resetTasbih = function() { tasbihCount = 0; document.getElementById('tasbih-btn').innerText = 0; };

        // === PRAYER TRACKER ===
        const TRACK_PRAYERS = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
        let prayerData = JSON.parse(localStorage.getItem('adhan_tracker')) || {};
        let trackerOffsetDays = 0;

        // Jump directly to a clicked date from history
        window.jumpToDate = function(dateStr) {
            const parts = dateStr.split('-');
            const target = new Date(parts[0], parts[1]-1, parts[2]);
            const today = new Date();
            today.setHours(0,0,0,0);
            target.setHours(0,0,0,0);
            const diffTime = target - today;
            trackerOffsetDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            updateTrackerView();
            // Scroll to tracker smoothly
            document.querySelector('.times-card').scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        window.changeTrackerDate = async function(delta) { trackerOffsetDays += delta; await updateTrackerView(); }

        window.toggleAllPrayers = function(dateStr) {
            const allDone = TRACK_PRAYERS.every(p => prayerData[dateStr] && prayerData[dateStr][p]);
            
            TRACK_PRAYERS.forEach(p => {
                prayerData[dateStr][p] = !allDone;
                const chk = document.getElementById('chk_' + p);
                if(chk) chk.checked = !allDone;
            });
            
            localStorage.setItem('adhan_tracker', JSON.stringify(prayerData));
            updateDailyProgressBar(dateStr);
            
            // If they just checked them all, fire confetti!
            if (!allDone && typeof confetti !== 'undefined') {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#D4AF37', '#2ecc71', '#ffffff'] });
            }
            updateStatistics();
        };

        function updateDailyProgressBar(dateStr) {
            let count = 0;
            if (prayerData[dateStr]) {
                count = TRACK_PRAYERS.filter(p => prayerData[dateStr][p]).length;
            }
            const bar = document.getElementById('daily-progress-fill');
            if (bar) bar.style.width = (count / 5 * 100) + '%';
        }

        async function updateTrackerView() {
            const targetDate = new Date(); targetDate.setDate(targetDate.getDate() + trackerOffsetDays);
            const reqDateStr = `${targetDate.getDate()}-${targetDate.getMonth()+1}-${targetDate.getFullYear()}`;
            const isoDateStr = targetDate.getFullYear() + '-' + String(targetDate.getMonth() + 1).padStart(2, '0') + '-' + String(targetDate.getDate()).padStart(2, '0');
            
            // Added ‚úì All button next to date
            document.getElementById('trackerDate').innerHTML = `${isoDateStr} &nbsp; <button onclick="toggleAllPrayers('${isoDateStr}')" style="background: transparent; border: 1px solid var(--gold); color: var(--gold); border-radius: 4px; padding: 2px 6px; font-size: 0.65rem; cursor: pointer; vertical-align: middle;">‚úì All</button>`;
            
            const timesList = document.getElementById('daily-times-list');
            timesList.innerHTML = '<div style="text-align: center; color: var(--text-muted);">Loading times...</div>';
            
            const data = await fetchCached(`prayers_${config.lat}_${config.lon}_${reqDateStr}`, `https://api.aladhan.com/v1/timings/${reqDateStr}?latitude=${config.lat}&longitude=${config.lon}&method=${config.method}`, 24);
            if(data && data.code === 200) {
                renderPrayerTracker(data.data.timings, isoDateStr);
                updateDailyProgressBar(isoDateStr);
            }
            else timesList.innerHTML = '<div style="text-align: center; color: var(--danger);">Offline / No data</div>';
        }

        function renderPrayerTracker(timings, dateStr) {
            if (!prayerData[dateStr]) {
                prayerData[dateStr] = { Fajr: false, Dhuhr: false, Asr: false, Maghrib: false, Isha: false };
                localStorage.setItem('adhan_tracker', JSON.stringify(prayerData));
            }
            const timesList = document.getElementById('daily-times-list'); timesList.innerHTML = '';
            const seq = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
            
            seq.forEach(p => {
                if(p === "Sunrise") {
                    timesList.innerHTML += `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 6px;"><span style="color: var(--danger); font-weight: bold; text-transform: uppercase; font-size: 0.85rem;">${p}</span><div style="display: flex; align-items: center;"><span style="color: var(--danger); font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: bold;">${timings[p]}</span><div style="width: 28px; margin-left: 15px;"></div></div></div>`;
                } else {
                    const isChecked = prayerData[dateStr][p] ? 'checked' : '';
                    timesList.innerHTML += `<label style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 6px; cursor: pointer;"><span style="color: var(--text-main); font-weight: bold; text-transform: uppercase; font-size: 0.85rem;">${p}</span><div style="display: flex; align-items: center;"><span style="color: var(--gold); font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: bold;">${timings[p]}</span><div style="width: 28px; margin-left: 15px;"><input type="checkbox" id="chk_${p}" ${isChecked} onchange="togglePrayer('${p}', '${dateStr}')" style="transform: scale(1.4); margin: 0; accent-color: var(--gold); cursor: pointer;"><span style="display:none;">${p} checkbox</span></div></div></label>`;
                }
            });
            updateStatistics();
        }

        window.togglePrayer = function(prayerName, dateStr) {
            const isNowChecked = document.getElementById('chk_' + prayerName).checked;
            prayerData[dateStr][prayerName] = isNowChecked;
            localStorage.setItem('adhan_tracker', JSON.stringify(prayerData));
            
            updateDailyProgressBar(dateStr);
            
            const prayersDone = TRACK_PRAYERS.filter(p => prayerData[dateStr][p]).length;
            if (prayersDone === 5 && isNowChecked && typeof confetti !== 'undefined') {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#D4AF37', '#2ecc71', '#ffffff'] });
            }
            updateStatistics();
        };

        function updateStatistics() {
            const d = new Date(); const actualTodayStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            const allDates = Object.keys(prayerData).sort().reverse();
            let weekCompleted = 0, weekMax = 0, monthCompleted = 0, monthMax = 0, entryCount = 0;
            const historyContainer = document.getElementById('historyLog'); historyContainer.innerHTML = '';

            // Streak Logic Calculation
            let streak = 0;
            let dateToIterate = new Date();
            let todayRec = prayerData[actualTodayStr];
            let todayDone = todayRec ? TRACK_PRAYERS.filter(p => todayRec[p]).length : 0;
            
            if (todayDone < 5) {
                // If today isn't 5/5 yet, start checking from yesterday
                dateToIterate.setDate(dateToIterate.getDate() - 1);
            }
            
            while(true) {
                let iterStr = dateToIterate.getFullYear() + '-' + String(dateToIterate.getMonth() + 1).padStart(2, '0') + '-' + String(dateToIterate.getDate()).padStart(2, '0');
                let rec = prayerData[iterStr];
                if (rec && TRACK_PRAYERS.filter(p => rec[p]).length === 5) {
                    streak++;
                    dateToIterate.setDate(dateToIterate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            document.getElementById('streakCount').innerText = streak;

            allDates.forEach((date, index) => {
                const dayRecord = prayerData[date]; const prayersDone = TRACK_PRAYERS.filter(p => dayRecord[p]).length;
                if (index < 7) { weekCompleted += prayersDone; weekMax += 5; }
                if (index < 30) { monthCompleted += prayersDone; monthMax += 5; }

                if (date !== actualTodayStr) {
                    entryCount++;
                    const color = prayersDone === 5 ? 'var(--success)' : (prayersDone === 0 ? 'var(--danger)' : 'var(--gold)');
                    const crown = prayersDone === 5 ? ' üåü' : ''; // Visual indicator for perfect days
                    historyContainer.innerHTML += `<div onclick="jumpToDate('${date}')" title="Click to edit this day" style="display: flex; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; border-radius: 6px; transition: 0.2s;" onmouseover="this.style.background='var(--progress-bg)'" onmouseout="this.style.background='transparent'"><span style="color: var(--text-muted);">${date}</span><span style="color: ${color}; font-weight: bold;">${prayersDone} / 5${crown}</span></div>`;
                }
            });

            document.getElementById('weekScore').innerText = weekCompleted; document.getElementById('weekTotal').innerText = weekMax;
            document.getElementById('weekBar').style.width = weekMax > 0 ? (weekCompleted / weekMax * 100) + '%' : '0%';
            document.getElementById('monthScore').innerText = monthCompleted; document.getElementById('monthTotal').innerText = monthMax;
            document.getElementById('monthBar').style.width = monthMax > 0 ? (monthCompleted / monthMax * 100) + '%' : '0%';
        }

        async function init() {
            try { applySettings(); } catch(e) {}
            requestWakeLock(); // Request wake lock on load immediately
            updateGregorian(); 
            setInterval(() => { const lc = document.getElementById('live-clock'); if(lc) lc.innerText = new Date().toLocaleTimeString('en-US', { hour12: false }); }, 1000);
            
            try { await initLocation(); } catch(e) {}
            fetchContent(); 
            
            setInterval(tickTimer, 1000); 
            setInterval(rotateNames, 10000); 
            setInterval(fetchPrayerData, 3600000); 
        }

        async function fetchWeather() {
            const data = await fetchCached(`weather_${config.lat}_${config.lon}`, `https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&current_weather=true`, 1);
            if(data && data.current_weather) document.getElementById('weather-display').innerText = `${Math.round(data.current_weather.temperature)}¬∞C | ${data.current_weather.weathercode < 3 ? 'Clear' : 'Cloudy'}`;
        }

        async function fetchPrayerData() {
            const now = new Date(); const dateStr = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
            const data = await fetchCached(`prayers_${config.lat}_${config.lon}_${dateStr}`, `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${config.lat}&longitude=${config.lon}&method=${config.method}`, 24);
            if(data && data.code === 200) {
                state.prayers = data.data.timings; const h = data.data.date.hijri;
                document.getElementById('hijri-date').innerText = `${h.day} ${h.month.en} ${h.year}`;
                if(parseInt(h.month.number) === 9) { state.isRamadan = true; activateRamadanMode(parseInt(h.day)); } 
                else { state.isRamadan = false; calcRamadanCountdown(parseInt(h.month.number), parseInt(h.day)); }
                document.getElementById('midnight-time').innerText = state.prayers.Midnight; document.getElementById('last-third-time').innerText = state.prayers.Lastthird;
                determinePrayerState(); updateDynamicTheme(); updateTrackerView();
            }
        }

        async function fetchContent() {
            const lang = localStorage.getItem('adhan_lang') || 'en';
            const dailySource = localStorage.getItem('adhan_daily') || 'quran';
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            
            // Ayah or Hadith based on toggle
            if (dailySource === 'quran') {
                const quranEditions = { en: 'en.asad', tr: 'tr.diyanet', nl: 'nl.leemhuis', fr: 'fr.hamidullah', de: 'de.aburida', es: 'es.cortes', ar: 'ar.alafasy' };
                const edition = quranEditions[lang] || 'en.asad';
                const ayahNumber = (dayOfYear % 6236) + 1;
                const ayahData = await fetchCached(`quran_${edition}_${ayahNumber}`, `https://api.alquran.cloud/v1/ayah/${ayahNumber}/${edition}`, 24);
                if(ayahData && ayahData.data) {
                    document.getElementById('daily-text').innerText = `"${ayahData.data.text}"`;
                    let surahName = lang === 'ar' ? ayahData.data.surah.name : ayahData.data.surah.englishName;
                    document.getElementById('daily-ref').innerText = surahName + " " + ayahData.data.surah.number + ":" + ayahData.data.numberInSurah;
                } else {
                    document.getElementById('daily-text').innerText = "Loading or offline...";
                }
            } else {
                // Dynamic Hadith API Fetch
                try {
                    const hadithNumber = (dayOfYear % 7500) + 1; // Sahih Bukhari has approx 7500 Hadiths
                    const hadithData = await fetchCached(`hadith_bukhari_${hadithNumber}`, `https://cdn.jsdelivr.net/npm/@fawazahmed0/hadith-api@1/editions/eng-bukhari/${hadithNumber}.json`, 24);
                    
                    if(hadithData && hadithData.hadiths && hadithData.hadiths[0]) {
                        // Stripping HTML tags safely
                        let rawText = hadithData.hadiths[0].text.replace(/<[^>]*>?/gm, '').trim();
                        document.getElementById('daily-text').innerText = `"${rawText}"`;
                        document.getElementById('daily-ref').innerText = `Sahih al-Bukhari ${hadithData.hadiths[0].hadithnumber}`;
                    } else { throw new Error("Fallback to static"); }
                } catch (e) {
                    const hIndex = dayOfYear % dailyHadiths.length;
                    document.getElementById('daily-text').innerText = `"${dailyHadiths[hIndex].text}"`;
                    document.getElementById('daily-ref').innerText = dailyHadiths[hIndex].ref;
                }
            }

            // Always load Dua in dedicated section
            const dIndex = dayOfYear % dailyDuas.length;
            document.getElementById('dua-text').innerText = `"${dailyDuas[dIndex].text}"`;
            document.getElementById('dua-ref').innerText = dailyDuas[dIndex].ref;

            // Load Allah Names
            const namesData = await fetchCached('allah_names_v1', 'https://api.aladhan.com/v1/asmaAlHusna', 720);
            if(namesData && namesData.data) { state.namesList = namesData.data; rotateNames(); }
        }

        function determinePrayerState() {
            if(!state.prayers || !state.prayers.Fajr) return;
            const now = new Date(); const seq = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
            for(let i=0; i<seq.length; i++) {
                const pTime = parseTime(state.prayers[seq[i]]);
                if(pTime > now) {
                    state.nextPrayer = { name: seq[i], time: pTime };
                    let prevName = i === 0 ? "Isha" : seq[i-1]; let prevTime = parseTime(state.prayers[prevName]);
                    if(i === 0) prevTime.setDate(prevTime.getDate() - 1);
                    state.prevPrayerTime = prevTime;
                    document.getElementById('curr-name').innerText = prevName; document.getElementById('curr-time').innerText = state.prayers[prevName];
                    document.getElementById('curr-name').style.color = prevName === "Sunrise" ? "var(--danger)" : "var(--gold)";
                    document.getElementById('shuruq-warning').style.display = prevName === "Sunrise" ? 'block' : 'none';
                    updateDynamicTheme(); state.notified10Min = false;
                    return;
                }
            }
            const fTime = parseTime(state.prayers.Fajr); fTime.setDate(fTime.getDate()+1);
            state.nextPrayer = { name: "Fajr", time: fTime }; state.prevPrayerTime = parseTime(state.prayers.Isha);
            document.getElementById('curr-name').innerText = "Isha"; document.getElementById('curr-time').innerText = state.prayers.Isha; 
            document.getElementById('curr-name').style.color = "var(--gold)"; document.getElementById('shuruq-warning').style.display = 'none';
            updateDynamicTheme(); state.notified10Min = false;
        }

        function tickTimer() {
            if(!state.nextPrayer) return;
            const now = new Date(); const diffMs = state.nextPrayer.time - now;
            
            // 10-Minute Notification Trigger
            if (diffMs <= 600000 && diffMs > 599000 && !state.notified10Min) { 
                if(localStorage.getItem('adhan_wudu') === 'true' && state.nextPrayer.name !== "Sunrise") { 
                    playAudio('chime'); 
                    showNotification(state.nextPrayer.name);
                }
                state.notified10Min = true; 
            }

            if (diffMs <= 0) { 
                if(!state.adhanPlayed) { playAudio('adhan'); state.adhanPlayed = true; }
                determinePrayerState(); state.adhanPlayed = false; return; 
            }
            
            const h = Math.floor(diffMs/3600000).toString().padStart(2,'0');
            const m = Math.floor((diffMs%3600000)/60000).toString().padStart(2,'0');
            const s = Math.floor((diffMs%60000)/1000).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
            
            if(state.prevPrayerTime) {
                const total = state.nextPrayer.time - state.prevPrayerTime;
                const elapsed = now - state.prevPrayerTime;
                document.getElementById('progress-fill').style.width = `${(elapsed/total)*100}%`;
            }

            if(state.isRamadan) {
                const fajrTime = parseTime(state.prayers.Fajr);
                const maghribTime = parseTime(state.prayers.Maghrib);
                let targetTime, label;
                if(now >= fajrTime && now < maghribTime) {
                    targetTime = maghribTime; label = "Time until Iftar (Maghrib)";
                } else {
                    targetTime = parseTime(state.prayers.Fajr);
                    if (now >= maghribTime) targetTime.setDate(targetTime.getDate() + 1);
                    label = "Time until Imsak (Fajr)";
                }
                const fastDiff = targetTime - now;
                const fh = Math.floor(fastDiff/3600000).toString().padStart(2,'0');
                const fm = Math.floor((fastDiff%3600000)/60000).toString().padStart(2,'0');
                const fs = Math.floor((fastDiff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('fasting-label').innerText = label;
                document.getElementById('fasting-timer').innerText = `${fh}:${fm}:${fs}`;
            }
        }

        function showNotification(prayerName) {
            const title = "Prayer Time Approaching";
            const options = {
                body: `10 minutes until ${prayerName}. Time for Wudu.`,
                icon: "images/adhan display muslim prayer times dashboard logo.png",
                badge: "images/adhan display muslim prayer times dashboard logo.png",
                vibrate: [200, 100, 200]
            };

            if (!("Notification" in window)) return;

            if (Notification.permission === "granted") {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.ready.then(reg => reg.showNotification(title, options));
                } else {
                    new Notification(title, options);
                }
            }
        }

        function activateRamadanMode(hijriDay) { 
            document.getElementById('ramadan-countdown-container').style.display = 'none'; 
            document.getElementById('ramadan-panel').style.display = 'block'; 
            let ashraName = "Mercy (Days 1-10)";
            if (hijriDay > 10 && hijriDay <= 20) ashraName = "Forgiveness (Days 11-20)";
            if (hijriDay > 20) ashraName = "Refuge (Days 21-30)";
            document.getElementById('ashra-label').innerText = `Ashra: ${ashraName}`;
            document.getElementById('ramadan-day-label').innerText = `Day ${hijriDay} of 30`;
            document.getElementById('ashra-progress-fill').style.width = `${(hijriDay / 30) * 100}%`;
        }

        function calcRamadanCountdown(m, d) { 
            document.getElementById('ramadan-countdown-container').style.display = 'flex'; 
            document.getElementById('ramadan-panel').style.display = 'none'; 
            let daysLeft = m < 9 ? Math.floor(((9 - m - 1) * 29.5) + (30 - d)) : Math.floor(((12 - m + 8) * 29.5) + (30 - d));
            document.getElementById('ramadan-val').innerText = daysLeft > 0 ? daysLeft : 0;
        }

        function calculateQibla() {
            const lat1 = config.lat * (Math.PI/180), lon1 = config.lon * (Math.PI/180), lat2 = 21.4225 * (Math.PI/180), lon2 = 39.8262 * (Math.PI/180);
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2), x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            document.getElementById('qibla-degree').innerText = Math.round(((Math.atan2(y, x) * 180/Math.PI) + 360) % 360) + "¬∞";
        }

        function rotateNames() {
            if(!state.namesList || !state.namesList.length) return;
            const item = state.namesList[Math.floor(Math.random()*state.namesList.length)];
            document.getElementById('allah-ar').innerText = item.name; document.getElementById('allah-en').innerText = item.transliteration;
            document.getElementById('allah-meaning').innerText = item.en.meaning; 
        }

        function parseTime(t) { const d = new Date(); const [h, m] = t.split(':'); return new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m); }
        function updateGregorian() { const n = new Date(); const el = document.getElementById('greg-date'); if(el) el.innerText = `${n.getDate()}/${n.getMonth()+1}/${n.getFullYear()}`; }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then((registration) => {
                    console.log('ServiceWorker registration successful');
                }).catch((err) => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        init();
    </script>
</body>
</html>
